<canvas width="400" height="400" id="canvas" style="border:1px solid black"></canvas>

<script>
function isInBounds (item, bounds) {

  if (item.x >= bounds.left && 
      item.x < bounds.right &&
      item.y >= bounds.top &&
      item.y < bounds.bottom) {
  
    return true;
  }

  return false;
}



var c = canvas.getContext('2d')
  , w = canvas.width
  , h = canvas.height
  ;

c.fillRect(0,0,w,h);

console.log(canvas.width, c);


var count = 0
  , maxItems = 4
  , maxLeaves = 4
  ;

Leaf = function (props) {

  if (typeof props == 'undefined') {
    return undefined;
  }

  if (!props.bounds) {
    return undefined;
  }


  if (props.hasOwnProperty('bounds')) {
    
    if (!props.bounds.hasOwnProperty('top')) {
      return undefined;
    }

    if (!props.bounds.hasOwnProperty('left')) {
      return undefined;
    }

    if (!props.bounds.hasOwnProperty('bottom')) {
      return undefined;
    }

    if (!props.bounds.hasOwnProperty('right')) {
      return undefined;
    }
  }

  count +=1;
  
  return {

    bounds: props.bounds,
    depth: props.depth + 1 || 0,
    
    id: count,
    leaves: [],
    items: [],

    draw: function () {
      
      function line (l) {
        var str = '';
        for (var i=0; i< l*3; i++) {
          str+=' ';
        }
        return str+'-';
      }

      function vals () {
        var str = '';
        if (this.items.length > 0) {
          this.items.forEach(function (subitem) {
            str += subitem.val
          });
        }
        return str
      }

      c.beginPath();
      c.moveTo(this.bounds.left * w, this.bounds.top* h);
      c.lineTo(this.bounds.right* w, this.bounds.top* h);
      c.lineTo(this.bounds.right* w, this.bounds.bottom* h);
      c.lineTo(this.bounds.left* w, this.bounds.bottom * h);
      c.closePath();
      c.strokeStyle='#FF0';
      c.stroke();

      this.items.forEach(function (item) {
        c.fillStyle='#F0F';
        c.fillRect((item.x * w)-8, (item.y * h)-8, 16, 16);
      });

      console.log(line(this.depth) + '['+this.depth+':'+vals.call(this)+']');

      this.leaves.forEach(function (subleaf) {
        subleaf.draw();
      });
    },
    
    getItems: function () {

      if (!this.items) {
        return;
      }

      if (this.items.length > 0) {
        return this.items;
      }

      if (this.leaves.length > 0) {
        
        var collect = []
          , i=0
          , subItems
          ;
        
        for (; i < 4; i++) {
          subItems = this.leaves[i].getItems();
          
          if (subItems && subItems.length > 0) {
            
            subItems.forEach(function (item) {
              collect.push(item);
            });

          }
        }

        return collect;
      }

    },

    getUnEmptyLeaves: function (snowball) {

      if (!snowball) {
        var snowball = [];
      }

      if (this.items.length > 0) {
        return snowball.concat([this]);
      }

      if (this.leaves.length > 0) {
        return snowball
          .concat(this.leaves[0].getUnEmptyLeaves())
          .concat(this.leaves[1].getUnEmptyLeaves())
          .concat(this.leaves[2].getUnEmptyLeaves())
          .concat(this.leaves[3].getUnEmptyLeaves())
          ;
      }

      return snowball.concat([]);
    },

    addItem: function (item) {
      if (!item) {
        return undefined;
      }

      if (typeof item == 'object') {
        
        if (!item.hasOwnProperty('x')) {
          return undefined;
        }

        if (!item.hasOwnProperty('y')) {
          return undefined;
        }

        if (!item.hasOwnProperty('val')) {
          return undefined;
        }

      }

      if (this.leaves.length > 0) {
        this.drop(item, this.leaves);
        return;
      }

      if (this.items.length < 4) {
        // REVIEW: The circular reference item.leaf could be a problem.
        // create a reference to this leaf for game engine performance
        item.leaf = this;
        this.items.push(item);
        return;
      }

      if (this.items.length === 4) {
        this.split.call(this);
        this.shuffle(this.items, this.leaves);
        this.items = [];
        this.drop(item, this.leaves);
        return;
      }
    },
    
    split: function () {
      var midX = this.bounds.left + (this.bounds.right - this.bounds.left) / 2;
      var midY = this.bounds.top + (this.bounds.bottom - this.bounds.top) / 2;

      var subBoundsTopLeft = {
        top: this.bounds.top,
        left: this.bounds.left,
        right: midX,
        bottom: midY,
      };

      var subBoundsTopRight = {
        top: this.bounds.top,
        left: midX,
        right: this.bounds.right,
        bottom: midY,
      };

      var subBoundsBottomRight = {
        top: midY,
        left: midX,
        right: this.bounds.right,
        bottom: this.bounds.bottom,
      };

      var subBoundsBottomLeft = {
        top: midY,
        left: this.bounds.left,
        right: midX,
        bottom: this.bounds.bottom,
      };

      this.leaves.push(
        Leaf({bounds: subBoundsTopLeft    , depth: this.depth }),
        Leaf({bounds: subBoundsTopRight   , depth: this.depth }),
        Leaf({bounds: subBoundsBottomRight, depth: this.depth }),
        Leaf({bounds: subBoundsBottomLeft , depth: this.depth })
      );
    },

    shuffle: function (items, leaves) {
      leaves.forEach(function (subleaf) {
        items.forEach(function (subitem) {
          if (isInBounds(subitem, subleaf.bounds)) {
            subleaf.addItem(subitem);
          }
        });
      });
    },

    drop: function (item, leaves) {
      // console.log(item.val);
      leaves.forEach(function (subleaf) {
        if (isInBounds(item, subleaf.bounds)) {
          subleaf.addItem(item);
        }
      });
    },

  }
}








var props = {
  bounds: {
    top: 0,
    left: 0,
    bottom: 1,
    right: 1,
  }
};


var leaf = Leaf(props);

leaf.addItem({ x: 0, y: 0, val: 'A' });
leaf.addItem({ x: 1, y: 0, val: 'B' });
leaf.addItem({ x: 1, y: 1, val: 'C' });
leaf.addItem({ x: 0, y: 1, val: 'D' });

leaf.addItem({ x: 0.125, y: 0.125, val: 'E' });
leaf.addItem({ x: 0.126, y: 0.126, val: 'F' });
leaf.addItem({ x: 0.127, y: 0.127, val: 'G' });

leaf.addItem({ x: 0.12171, y: 0.1271, val: 'H' });

leaf.draw();
  
</script>